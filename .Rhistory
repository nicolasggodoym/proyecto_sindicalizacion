summarise(a = survey_total(na.rm = T)) %>%
ungroup() %>%
filter(contract_type == "Completa" & cp_priv == "CP/Priv" & !is.na(ciiu)) %>%
select(ciiu, contract_type = a)) %>%
imap(.,
~.x %>% mutate(ano = .y))
beep(1)
olas = as.character(seq(1998, 2019))
a = a[olas]
contract_type = bind_rows(a)
contract_type_ano = contract_type %>%
group_by(ano) %>%
summarise(ciiu = "Total",
contract_type = sum(contract_type)) %>%
ungroup()
contract_type = rbind(contract_type, contract_type_ano)
rm(contract_type_ano)
contract_type = contract_type[order(contract_type$ano, contract_type$ciiu),]
a = enc %>%
map_if(.,
~mean(.x$variables$ano) %in% c(1998:2019),
~.x %>%
group_by(ciiu, cp_priv, unempl) %>%
summarise(a = survey_total(na.rm = T)) %>%
ungroup() %>%
filter(unempl == "Desempleado" & cp_priv == "CP/Priv" & !is.na(ciiu)) %>%
select(ciiu, unempl = a)) %>%
imap(.,
~.x %>% mutate(ano = .y))
beep(1)
olas = as.character(seq(1998, 2019))
a = a[olas]
unempl = bind_rows(a)
unempl_ano = unempl %>%
group_by(ano) %>%
summarise(ciiu = "Total",
unempl = sum(unempl)) %>%
ungroup()
unempl = rbind(unempl, unempl)
rm(unempl_ano)
unempl = unempl[order(unempl$ano, unempl$ciiu),]
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type,
unempl)
View(age)
lista = lista %>% reduce(inner_join, by = c("ciiu", "ano"))
?reduce
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type,
unempl)
View(lista)
a = enc %>%
map_if(.,
~mean(.x$variables$ano) %in% c(1998:2019),
~.x %>%
group_by(unempl) %>%
summarise(a = survey_total(na.rm = T)) %>%
ungroup() %>%
filter(unempl == "Desempleado" & cp_priv == "CP/Priv" & !is.na(ciiu)) %>%
select(unempl = a)) %>%
imap(.,
~.x %>% mutate(ano = .y))
a = enc %>%
map_if(.,
~mean(.x$variables$ano) %in% c(1998:2019),
~.x %>%
group_by(unempl) %>%
summarise(a = survey_total(na.rm = T)) %>%
ungroup() %>%
filter(unempl == "Desempleado") %>%
select(unempl = a)) %>%
imap(.,
~.x %>% mutate(ano = .y))
beep(1)
olas = as.character(seq(1998, 2019))
a = a[olas]
unempl = bind_rows(a)
unempl_ano = unempl %>%
group_by(ano) %>%
summarise(#ciiu = "Total",
unempl = sum(unempl)) %>%
ungroup()
unempl = rbind(unempl, unempl)
rm(unempl_ano)
unempl = unempl[order(unempl$ano, unempl$ciiu),]
unempl = unempl[order(unempl$ano),]
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista = lista %>% reduce(inner_join, by = c("ciiu", "ano"))
View(lista)
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista = lista %>% reduce(inner_join, by = c("ciiu", "ano"), all = T)
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista = lista %>% Reduce(function(x,y) merge (x,y all = T), .)
lista = lista %>% Reduce(function(x,y) merge (x,y, all = T), .)
View(lista)
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu)
View(lista)
View(lista)
names(lista)
?lag
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type),
~ifelse(!is.na(.), round((./total)*100,3), NA))) %>%
ungroup() %>%
group_by(ano, ciiu) %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type),
~ifelse(!is.na(lag(.)), lag(.), NA))) %>%
ungroup()
?across
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type),
~ifelse(!is.na(.), round((./total)*100,3), NA))) %>%
ungroup() %>%
group_by(ano, ciiu) %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type),
~ifelse(!is.na(lag(.)), lag(.), NA),
.names = "{lag_}{col}")) %>%
ungroup()
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type),
~ifelse(!is.na(.), round((./total)*100,3), NA))) %>%
ungroup() %>%
group_by(ano, ciiu) %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type),
~ifelse(!is.na(lag(.)), lag(.), NA),
.names = "lag_{.col}")) %>%
ungroup()
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type),
~ifelse(!is.na(.), round((./total)*100,3), NA))) %>%
ungroup() %>%
merge(., unempl, by = "ano", all = T) %>%
group_by(ano, ciiu) %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type),
~ifelse(!is.na(lag(.)), lag(.), NA),
.names = "lag_{.col}")) %>%
ungroup()
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type),
~ifelse(!is.na(.), round((./total)*100,3), NA))) %>%
ungroup() %>%
merge(., unempl, by = "ano", all = T) %>%
group_by(ano, ciiu) %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type, unempl),
~ifelse(!is.na(lag(.)), lag(.), NA),
.names = "lag_{.col}")) %>%
ungroup()
View(lista)
View(unempl)
unempl = unique(unempl)
View(unempl)
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type),
~ifelse(!is.na(.), round((./total)*100,3), NA))) %>%
ungroup() %>%
merge(., unempl, by = "ano", all = T)
View(lista)
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
merge(., unempl, by = "ano", all = T) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type, unempl),
~ifelse(!is.na(.), round((./total)*100,3), NA))) %>%
ungroup() %>%
group_by(ano, ciiu) %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type, unempl),
~ifelse(!is.na(lag(.)), lag(.), NA),
.names = "lag_{.col}")) %>%
ungroup()
View(lista)
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista2 = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
merge(., unempl, by = "ano", all = T) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type, unempl),
~ifelse(!is.na(.), round((./total)*100,3), NA))) %>%
ungroup()
View(lista2)
names(lista)
lista = list(totales,
female,
age,
self_empl,
skills,
contract_duration,
tamano,
job_seniority,
contract_type#, unempl
)
lista2 = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu)
names(lista2)
lista2 = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
merge(., unempl, by = "ano", all = T) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, contract_type, unempl),
~ifelse(!is.na(.), round((./total)*100,3), NA))) %>%
ungroup()
View(lista2)
lista2 = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
merge(., unempl, by = "ano", all = T) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, contract_type),
~ifelse(!is.na(.), round((./total)*100,3), NA)),
unempl = ifelse(ciiu == "Total", round((unempl/total)*100,3), NA)) %>%
ungroup()
View(lista2)
lista2 = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
merge(., unempl, by = "ano", all = T) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, contract_type),
~ifelse(!is.na(.), round((./total)*100,3), NA)),
unempl = ifelse(ciiu == "Total", round((unempl/total)*100,3), NA)) %>%
ungroup() %>%
group_by(ano, ciiu) %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type, unempl),
~ifelse(!is.na(lag(.)), lag(.), NA),
.names = "lag_{.col}")) %>%
ungroup()
View(lista2)
lista2 = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
merge(., unempl, by = "ano", all = T) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, contract_type),
~ifelse(!is.na(.), round((./total)*100,3), NA)),
unempl = ifelse(ciiu == "Total", round((unempl/total)*100,3), NA)) %>%
ungroup() %>%
arrange(ciiu, ano) %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type, unempl),
~lag(.),
.names = "lag_{.col}")) %>%
arrange(ano, ciiu)
View(lista2)
lista2 = lista %>% Reduce(function(x,y) merge (x,y, all = T), .) %>%
arrange(ano, ciiu) %>%
mutate(self_empl = ifelse(ciiu %in% "4. Suministro de electricidad, gas y agua" & ano %in% "1998",
0, self_empl)) %>%
merge(., unempl, by = "ano", all = T) %>%
rowwise() %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, contract_type),
~ifelse(!is.na(.), round((./total)*100,3), NA)),
unempl = ifelse(ciiu == "Total", round((unempl/total)*100,3), NA)) %>%
ungroup() %>%
arrange(ciiu, ano) %>%
mutate(across(c(female, self_empl, skills, contract_duration,
firm_size, job_seniority, contract_type, unempl),
~lag(.),
.names = "lag_{.col}")) %>%
arrange(ano, ciiu) %>%
filter(ano != "1998")
View(lista2)
write_xlsx(lista, "output/data/ene_final.xlsx")
rm(list=ls())
dt = read_xlsx("input/data/anuario_dt.xlsx",
sheet = "resumen",
range = "B1:J341") %>%
mutate(actividad_raw = factor(actividad_raw))
pacman::p_load(tidyverse,
ggplot2,
sjmisc,
readxl,
writexl,
ggrepel,
patchwork)
# Cargar datos ------------------------------------------------------------
dt = read_xlsx("input/data/anuario_dt.xlsx",
sheet = "resumen",
range = "B1:J341") %>%
mutate(actividad_raw = factor(actividad_raw))
ohl = readRDS("output/data/ohl.rds")
data = merge(dt %>%
filter(ano %in% c(1998:2019) & !is.na(actividad_raw)) %>%
select(ano, actividad_raw, afiliados, ocupados_autoemp, tasa_sind, tasa_sind_per,
n_sind, n_sind_mil),
ohl %>%
filter(ano %in% c(1998:2019) & !is.na(actividad_raw)) %>%
group_by(ano, actividad_raw) %>%
summarise(n_huelgas = n(),
dptp = round(mean(dptp, na.rm = T), 2),
tc = round(mean(tc, na.rm = T), 2)) %>%
ungroup(),
by = c("ano", "actividad_raw"))
write_xlsx(data, "output/data/data_graficos_dtohl.xlsx")
dt = read_xlsx("input/data/anuario_dt.xlsx",
sheet = "resumen",
range = "B1:J341") %>%
mutate(actividad_raw = factor(actividad_raw))
ohl = readRDS("output/data/ohl.rds")
data = merge(dt %>%
filter(ano %in% c(1998:2019) & !is.na(actividad_raw)) %>%
select(ano, actividad_raw, afiliados, ocupados_autoemp, tasa_sind, tasa_sind_per,
n_sind, n_sind_mil),
ohl %>%
filter(ano %in% c(1998:2019) & !is.na(actividad_raw)) %>%
group_by(ano, actividad_raw) %>%
summarise(n_huelgas = n(),
dptp = round(mean(dptp, na.rm = T), 2),
tc = round(mean(tc, na.rm = T), 2)) %>%
ungroup(),
by = c("ano", "actividad_raw")) %>%
arrange(actividad_raw, ano) %>%
mutate(across(c(afiliados, ocupados_autoemp, tasa_sind, tasa_sind_per,
n_sind, n_sind_mil, n_huelgas, dptp, tc),
~lag(.),
.names = "lag_{.col}")) %>%
arrange(ano, actividad_raw) %>%
filter(ano != "1998")
write_xlsx(data, "output/data/data_graficos_dtohl.xlsx")
pacman::p_load(tidyverse,
readxl,
writexl,
sjmisc)
ene = read_xlsx("output/data/ene_final.xlsx")
dtohl = read_xlsx("output/data/data_graficos_dtohl.xlsx")
View(dtohl)
data = merge(ene, dtohl %>% rename(ciiu = actividad_raw),
by = c("ano", "ciiu"), all = T)
View(data)
names(data)
