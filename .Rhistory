ooss_conf, by = c("rsu", "ano"),
all.x = T) %>%
merge(.,
ooss_cen, by = c("rsu", "ano"),
all.x = T) %>%
bind_rows(., ooss_micro23 %>%
mutate(rut_empresa = paste(rut_empresa, dv, sep = "-")) %>%
select(-dv)) %>%
mutate(across(starts_with("rsu_"), ~ifelse(. == "-", NA, .)))
View(ooss)
ooss = ooss_micro %>%
merge(.,
ooss_fed, by = c("rsu", "ano"),
all.x = T) %>%
merge(.,
ooss_conf, by = c("rsu", "ano"),
all.x = T) %>%
merge(.,
ooss_cen, by = c("rsu", "ano"),
all.x = T) %>%
bind_rows(., ooss_micro23 %>%
mutate(rut_empresa = paste(rut_empresa, dv, sep = "-")) %>%
select(-dv)) %>%
mutate(across(starts_with("rsu_"), ~ifelse(. == "-", NA, .)),
rut_empresa = ifelse(rut_empresa %in% c("0", "0-NA"), NA, rut_empresa))
saveRDS(ooss, "input/data/dt/ooss.rds")
View(ooss)
ooss_micro23 = ooss_micro[[8]] %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes,
rsu_fed = rsu_federacion_rsu_fed,
rsu_cen = rsu_central_sindical_rsu_cent,
rsu_conf = rsu_confederacion_rsu_confed
) %>%
mutate(rut_empresa = paste(rut_empresa, dv, sep = "-")) %>%
select(-dv) %>%
merge(., llave, by = "rut_empresa", all.x = T)
ooss_micro23 = ooss_micro[[8]] %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes,
rsu_fed = rsu_federacion_rsu_fed,
rsu_cen = rsu_central_sindical_rsu_cent,
rsu_conf = rsu_confederacion_rsu_confed
) %>%
mutate(rut_empresa = paste(rut_empresa, dv, sep = "-")) %>%
dplyr::select(-dv) %>%
merge(., llave, by = "rut_empresa", all.x = T)
rm(list = ls())
# Procesamiento data OOSS --------------------------------------
# Cargar paquetes ---------------------------------------------------------
pacman::p_load(tidyverse, readxl, sjmisc)
# Cargar datos ------------------------------------------------------------
llave = readRDS("input/data/dt/CAE_RUT_FINAL.rds") %>%
select(rut_empresa = rut, dv, id_cae2) %>%
mutate(across(c(rut_empresa, dv), ~as.character(.)),
id_cae2 = as.numeric(id_cae2),
rut_empresa = paste(rut_empresa, dv, sep = "-")) %>% #con duplicados: 3.482.146
group_by(rut_empresa) %>%
mutate(n = 1:n()) %>%
ungroup() %>%
filter(n==1) %>% #Sin duplicados: 1.617.697
select(-dv, -n)
llave = merge(llave, read_xlsx("input/data/dt/CAE_DT_armonizado.xlsx") %>%
select(id_cae2, ID),
by = "id_cae2", all.x = T)
# a %>%
#   group_by(rut_empresa, id_cae2) %>%
#   mutate(n = n()) %>%
#   ungroup() %>%
#   summarise(uniq = sum(n==1),
#             uniq_p = sum(n==1)/nrow(.)*100,
#             dup = sum(n>1),
#             dup_p = sum(n>1)/nrow(.)*100)
#
# a %>%
#   group_by(rut_empresa, ID) %>%
#   mutate(n = n()) %>%
#   ungroup() %>%
#   summarise(uniq = sum(n==1),
#             uniq_p = sum(n==1)/nrow(.)*100,
#             dup = sum(n>1),
#             dup_p = sum(n>1)/nrow(.)*100)
#
# a %>%
#   #group_by(rut_empresa) %>%
#   summarise(serv = sum(ID %in% 39:43, na.rm=T)/nrow(.))
files = list.files(path = "input/data/dt",
pattern = "1594")
#Microdatos
ooss_micro = map(files,
~ read_xlsx(paste0("input/data/dt/", .x),
na = c("SIN INFORMACIÓN", "NULL")) %>%
janitor::clean_names())
names(ooss_micro) = str_extract(files, pattern = "(OOSS_|COES_)\\d{4}")
ooss_micro = imap(ooss_micro,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
ooss_micro23 = ooss_micro[[8]] %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes,
rsu_fed = rsu_federacion_rsu_fed,
rsu_cen = rsu_central_sindical_rsu_cent,
rsu_conf = rsu_confederacion_rsu_confed
) %>%
mutate(rut_empresa = paste(rut_empresa, dv, sep = "-")) %>%
dplyr::select(-dv) %>%
merge(., llave, by = "rut_empresa", all.x = T)
ooss_micro = bind_rows(ooss_micro[-8]) %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes)
ooss_micro = ooss_micro %>% #sin merge 168.908
mutate(rut_empresa = paste(rut_empresa, dv, sep = "-")) %>%
select(-dv) %>%
merge(., llave, by = "rut_empresa", all.x = T)  #Con merge 169.230
#Pasa de 168.908 a 470.622
# ooss_micro_b %>%
#   mutate(info = case_when(is.na(id_cae2) & !is.na(cae_1d) ~ "Sólo DT",
#                           !is.na(id_cae2) & is.na(cae_1d) ~ "Sólo SII",
#                           !is.na(id_cae2) & !is.na(cae_1d) ~ "Ambas",
#                           TRUE ~ "Ninguna")) %>%
#   group_by(info) %>%
#   count %>%
#   mutate(prop = round(n/nrow(ooss_micro_b)*100, 3))
#
# ooss_micro_b %>%
#   group_by(rut_empresa) %>%
#   summarise(sii = n_distinct(id_cae2),
#             dt = n_distinct(cae_1d),
#             armonizacion = n_distinct(ID)) %>%
#   summarise(across(c(sii, dt, armonizacion),
#                    list(mean = ~mean(.),
#                         q1 = ~quantile(., 0.25),
#                         q2 = ~quantile(., 0.5),
#                         q3 = ~quantile(., 0.75),
#                         min = ~min(.),
#                         max = ~max(.)))) %>%
#   pivot_longer(everything()) %>%
#   mutate(stat = str_extract(name, pattern = "(?<=_).*"),
#          name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
#   pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
# a %>% group_by(rut_empresa) %>% summarise(n=n()) %>% summarise(dup = sum(n>1),
#                                                                uniq = sum(n==1))
#sum(is.na(a$rut_empresa))
saveRDS(ooss_micro, "input/data/dt/ooss_micro.rds")
#Federaciones
ooss_fed = map(files[-8],
~ read_xlsx(paste0("input/data/dt/", .x),
sheet = "Federaciones",
na = "SIN INFORMACIÓN") %>%
janitor::clean_names() %>%
mutate(across(c(rsu_federacion_rsu_fed, rsu_raf), ~as.character(.))))
names(ooss_fed) = str_extract(files[-8], pattern = "OOSS_\\d{4}")
ooss_fed = imap(ooss_fed,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
ooss_fed = bind_rows(ooss_fed) %>%
select(rsu = rsu_raf, ano = anno,
rsu_fed = rsu_federacion_rsu_fed,
tipo_org_fed = tipo_de_federacion)
saveRDS(ooss_fed, "input/data/dt/ooss_fed.rds")
#Confederaciones
ooss_conf = map(files[-8],
~ read_xlsx(paste0("input/data/dt/", .x),
sheet = "Confederaciones",
na = "SIN INFORMACIÓN") %>%
janitor::clean_names() %>%
mutate(across(c(rsu_confederacion_rsu_confed, rsu_raf), ~as.character(.))))
names(ooss_conf) = str_extract(files[-8], pattern = "OOSS_\\d{4}")
ooss_conf = imap(ooss_conf,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
ooss_conf = bind_rows(ooss_conf) %>%
select(rsu = rsu_raf, ano = anno,
rsu_conf = rsu_confederacion_rsu_confed,
tipo_org_conf = tipo_de_confederacion)
saveRDS(ooss_conf, "input/data/dt/ooss_conf.rds")
#Centrales
ooss_cen = map(files[-8],
~ read_xlsx(paste0("input/data/dt/", .x),
sheet = "Centrales",
na = "SIN INFORMACIÓN") %>%
janitor::clean_names() %>%
mutate(across(c(rsu_central_sindical_rsu_cent, rsu_raf), ~as.character(.))))
names(ooss_cen) = str_extract(files[-8], pattern = "OOSS_\\d{4}")
ooss_cen = imap(ooss_cen,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
ooss_cen = bind_rows(ooss_cen) %>%
select(rsu = rsu_raf, ano = anno,
rsu_cen = rsu_central_sindical_rsu_cent,
tipo_org_cen = sigla)
saveRDS(ooss_cen, "input/data/dt/ooss_cen.rds")
# Unificar ----------------------------------------------------------------
ooss = ooss_micro %>%
merge(.,
ooss_fed, by = c("rsu", "ano"),
all.x = T) %>%
merge(.,
ooss_conf, by = c("rsu", "ano"),
all.x = T) %>%
merge(.,
ooss_cen, by = c("rsu", "ano"),
all.x = T) %>%
bind_rows(., ooss_micro23 %>%
mutate(rut_empresa = paste(rut_empresa, dv, sep = "-")) %>%
select(-dv)) %>%
mutate(across(starts_with("rsu_"), ~ifelse(. == "-", NA, .)),
rut_empresa = ifelse(rut_empresa %in% c("0", "0-NA"), NA, rut_empresa))
ooss = ooss_micro %>%
merge(.,
ooss_fed, by = c("rsu", "ano"),
all.x = T) %>%
merge(.,
ooss_conf, by = c("rsu", "ano"),
all.x = T) %>%
merge(.,
ooss_cen, by = c("rsu", "ano"),
all.x = T) %>%
bind_rows(., ooss_micro23) %>%
mutate(across(starts_with("rsu_"), ~ifelse(. == "-", NA, .)),
rut_empresa = ifelse(rut_empresa %in% c("0", "0-NA"), NA, rut_empresa))
View(ooss)
saveRDS(ooss, "input/data/dt/ooss.rds")
rm(list=ls())
# Rev datos DT - total ----------------------------------------------------
# Cargar paquetes ---------------------------------------------------------
pacman::p_load(tidyverse, sjmisc, readxl, data.table)
# Cargar data -------------------------------------------------------------
# NC y Huelgas ------------------------------------------------------------
files = list.files("input/data/dt", pattern = ".rds")[2:4]
nc_h = map(files, ~readRDS(paste0("input/data/dt/", .x)))
names(nc_h) = str_remove(files, pattern = ".rds$")
list2env(nc_h, globalenv())
rm(nc_h)
# OOSS --------------------------------------------------------------------
ooss = readRDS("input/data/dt/ooss.rds")
# Estimaciones ------------------------------------------------------------
# Número de trabajadores --------------------------------------------------
h_nt = huelgas_ntrab_dt %>%
group_by(rut_empresa, rsu, fecha) %>%
mutate(n = 1:n()) %>%
filter(n==1) %>%
ungroup() %>%
group_by(ID, ano) %>%
summarise(n_huelgas = n(),
n_trab_huelga_tot = sum(trab_tot_h, na.rm = T),
n_trab_huelga_fem = sum(trab_fem_h, na.rm = T),
n_trab_huelga_mas = sum(trab_mas_h, na.rm = T),
mean_trab_huelga_tot = mean(trab_tot_h, na.rm = T),
mean_trab_huelga_fem = mean(trab_fem_h, na.rm = T),
mean_trab_huelga_mas = mean(trab_mas_h, na.rm = T)) %>%
filter(!is.na(ID))
h_dur = huelgas_dur_dt %>%
group_by(rut_empresa, rsu, fecha) %>%
mutate(n = 1:n()) %>%
filter(n==1) %>%
ungroup() %>%
group_by(ID, ano) %>%
summarise(huelgas_dur = mean(dias_h, na.rm = T),
n_dptp = sum(trab_tot_h*dias_h),
mean_dptp = mean(trab_tot_h*dias_h)) %>%
filter(!is.na(ID))
nc = neg_col_dt %>%
group_by(rut_empresa, rsu, ano) %>%
mutate(n = 1:n()) %>%
filter(n==1) %>%
ungroup() %>%
group_by(ID, ano) %>%
summarise(cubiertos_tot = sum(trab_tot_nc, na.rm = T),
cubiertos_fem = sum(trab_fem_nc, na.rm = T),
cubiertos_mas = sum(trab_mas_nc, na.rm = T)) %>%
filter(!is.na(ID))
nc_contrato = neg_col_dt %>%
group_by(rut_empresa, rsu, ano) %>%
mutate(n = 1:n()) %>%
filter(n==1 & tipo_inst == "Contrato Colectivo") %>%
ungroup() %>%
group_by(ID, ano) %>%
summarise(cubiertos_cont = sum(trab_tot_nc, na.rm = T),
cubiertos_cont_fem = sum(trab_fem_nc, na.rm = T),
cubiertos_cont_mas = sum(trab_mas_nc, na.rm = T)) %>%
filter(!is.na(ID))
nc_otro = neg_col_dt %>%
group_by(rut_empresa, rsu, ano) %>%
mutate(n = 1:n()) %>%
filter(n==1 & tipo_inst != "Contrato Colectivo") %>%
ungroup() %>%
group_by(ID, ano) %>%
summarise(cubiertos_otro = sum(trab_tot_nc, na.rm = T),
cubiertos_otro_fem = sum(trab_fem_nc, na.rm = T),
cubiertos_otro_mas = sum(trab_mas_nc, na.rm = T)) %>%
filter(!is.na(ID))
sind = ooss %>%
group_by(rut_empresa, rsu, ano) %>%
mutate(n = 1:n()) %>%
filter(n==1) %>%
ungroup() %>%
group_by(ID, ano) %>%
summarise(n_sind = n(),
n_afil_tot = sum(afil_tot, na.rm = T),
n_afil_mas = sum(afil_mas, na.rm = T),
n_afil_fem = sum(afil_fem, na.rm = T),
mean_afil_tot = mean(afil_tot, na.rm = T),
mean_afil_mas = mean(afil_mas, na.rm = T),
mean_afil_fem = mean(afil_fem, na.rm = T),
por_dir_fem = round(sum(n_dir_mas<n_dir_tot, na.rm = T)/n()*100,3),
por_fed = round(sum(!is.na(rsu_fed))/n()*100, 3),
por_conf = round(sum(!is.na(rsu_conf))/n()*100, 3),
por_cen = round(sum(!is.na(rsu_cen))/n()*100, 3)) %>%
filter(!is.na(ID))
data = list(nc, nc_contrato, nc_otro, h_nt, h_dur, sind) %>%
reduce(full_join, by = c("ID", "ano"))
saveRDS(data, "output/data/data_dt_proc_final.rds")
rm(list=ls())
# Unificar data ENE - DT (OOSS-NC-H) --------------------------------------
# Cargar paquetes ---------------------------------------------------------
pacman::p_load(tidyverse, sjmisc)
# Cargar data -------------------------------------------------------------
dt = readRDS("output/data/data_dt_proc_final.rds")
ene = readRDS("output/data/ene_final_ID.rds") %>%
mutate(ID = as.numeric(ID),
ano = as.numeric(ano)) %>%
filter(!is.na(ID))
# Unificar ----------------------------------------------------------------
data = list(ene, dt) %>%
reduce(full_join, by = c("ID", "ano")) %>%
arrange(ano, ID) %>%
filter(ano %in% 2010:2023) %>%
mutate(across(total:por_cen,
~tidyr::replace_na(., 0)),
tasa_afiliacion = ifelse(if_all(c(n_afil_tot, total), ~.!=0), round((n_afil_tot/total)*100,3), 0),
por_cobertura = ifelse(if_all(c(cubiertos_tot, total), ~.!=0), round((cubiertos_tot/total)*100,3), 0),
por_cobertura_cont = ifelse(if_all(c(cubiertos_cont, total), ~.!=0), round((cubiertos_cont/total)*100,3), 0),
por_cobertura_otro = ifelse(if_all(c(cubiertos_otro, total), ~.!=0), round((cubiertos_otro/total)*100,3), 0),
n_sind_mil = ifelse(if_all(c(n_sind, total), ~.!=0), round((n_sind/(total/1000))*100,3), 0)) %>%
arrange(ID, ano) %>%
group_by(ID, ano) %>%
mutate(across(c(tasa_afiliacion, por_cobertura_tot, por_cobertura_cont, por_cobertura_otro),
~lag(.),
.names = "lag_{.col}")) %>%
ungroup()
# Unificar data ENE - DT (OOSS-NC-H) --------------------------------------
# Cargar paquetes ---------------------------------------------------------
pacman::p_load(tidyverse, sjmisc)
# Cargar data -------------------------------------------------------------
dt = readRDS("output/data/data_dt_proc_final.rds")
ene = readRDS("output/data/ene_final_ID.rds") %>%
mutate(ID = as.numeric(ID),
ano = as.numeric(ano)) %>%
filter(!is.na(ID))
names(dt)
# Unificar ----------------------------------------------------------------
data = list(ene, dt) %>%
reduce(full_join, by = c("ID", "ano")) %>%
arrange(ano, ID) %>%
filter(ano %in% 2010:2023) %>%
mutate(across(total:por_cen,
~tidyr::replace_na(., 0)),
tasa_afiliacion = ifelse(if_all(c(n_afil_tot, total), ~.!=0), round((n_afil_tot/total)*100,3), 0),
por_cobertura = ifelse(if_all(c(cubiertos_tot, total), ~.!=0), round((cubiertos_tot/total)*100,3), 0),
por_cobertura_cont = ifelse(if_all(c(cubiertos_cont, total), ~.!=0), round((cubiertos_cont/total)*100,3), 0),
por_cobertura_otro = ifelse(if_all(c(cubiertos_otro, total), ~.!=0), round((cubiertos_otro/total)*100,3), 0),
n_sind_mil = ifelse(if_all(c(n_sind, total), ~.!=0), round((n_sind/(total/1000))*100,3), 0)) %>%
arrange(ID, ano) %>%
group_by(ID, ano) %>%
mutate(across(c(tasa_afiliacion, por_cobertura, por_cobertura_cont, por_cobertura_otro),
~lag(.),
.names = "lag_{.col}")) %>%
ungroup()
View(data)
?lag
# Unificar ----------------------------------------------------------------
data = list(ene, dt) %>%
reduce(full_join, by = c("ID", "ano")) %>%
arrange(ano, ID) %>%
filter(ano %in% 2010:2023) %>%
mutate(across(total:por_cen,
~tidyr::replace_na(., 0)),
tasa_afiliacion = ifelse(if_all(c(n_afil_tot, total), ~.!=0), round((n_afil_tot/total)*100,3), 0),
por_cobertura = ifelse(if_all(c(cubiertos_tot, total), ~.!=0), round((cubiertos_tot/total)*100,3), 0),
por_cobertura_cont = ifelse(if_all(c(cubiertos_cont, total), ~.!=0), round((cubiertos_cont/total)*100,3), 0),
por_cobertura_otro = ifelse(if_all(c(cubiertos_otro, total), ~.!=0), round((cubiertos_otro/total)*100,3), 0),
n_sind_mil = ifelse(if_all(c(n_sind, total), ~.!=0), round((n_sind/(total/1000))*100,3), 0)) %>%
arrange(ID, ano) %>%
group_by(ID, ano) %>%
mutate(across(c(tasa_afiliacion, por_cobertura, por_cobertura_cont, por_cobertura_otro),
~dplyr::lag(.),
.names = "lag_{.col}")) %>%
ungroup()
View(data)
# Unificar ----------------------------------------------------------------
data = list(ene, dt) %>%
reduce(full_join, by = c("ID", "ano")) %>%
arrange(ano, ID) %>%
filter(ano %in% 2010:2023) %>%
mutate(across(total:por_cen,
~tidyr::replace_na(., 0)),
tasa_afiliacion = ifelse(if_all(c(n_afil_tot, total), ~.!=0), round((n_afil_tot/total)*100,3), 0),
por_cobertura = ifelse(if_all(c(cubiertos_tot, total), ~.!=0), round((cubiertos_tot/total)*100,3), 0),
por_cobertura_cont = ifelse(if_all(c(cubiertos_cont, total), ~.!=0), round((cubiertos_cont/total)*100,3), 0),
por_cobertura_otro = ifelse(if_all(c(cubiertos_otro, total), ~.!=0), round((cubiertos_otro/total)*100,3), 0),
n_sind_mil = ifelse(if_all(c(n_sind, total), ~.!=0), round((n_sind/(total/1000))*100,3), 0)) %>%
arrange(ID, ano) %>%
#group_by(ID, ano) %>%
mutate(across(c(tasa_afiliacion, por_cobertura, por_cobertura_cont, por_cobertura_otro),
~dplyr::lag(.),
.names = "lag_{.col}")) %>%
ungroup()
View(data)
# Unificar ----------------------------------------------------------------
data = list(ene, dt) %>%
reduce(full_join, by = c("ID", "ano")) %>%
arrange(ano, ID) %>%
filter(ano %in% 2010:2023) %>%
mutate(across(total:por_cen,
~tidyr::replace_na(., 0)),
tasa_afiliacion = ifelse(if_all(c(n_afil_tot, total), ~.!=0), round((n_afil_tot/total)*100,3), 0),
por_cobertura = ifelse(if_all(c(cubiertos_tot, total), ~.!=0), round((cubiertos_tot/total)*100,3), 0),
por_cobertura_cont = ifelse(if_all(c(cubiertos_cont, total), ~.!=0), round((cubiertos_cont/total)*100,3), 0),
por_cobertura_otro = ifelse(if_all(c(cubiertos_otro, total), ~.!=0), round((cubiertos_otro/total)*100,3), 0),
n_sind_mil = ifelse(if_all(c(n_sind, total), ~.!=0), round((n_sind/(total/1000))*100,3), 0)) %>%
arrange(ID, ano) %>%
#group_by(ID, ano) %>%
mutate(across(c(tasa_afiliacion, por_cobertura, por_cobertura_cont, por_cobertura_otro),
~ifelse(year %in% 2011:2023, dplyr::lag(.), 0),
.names = "lag_{.col}")) %>%
ungroup()
# Unificar ----------------------------------------------------------------
data = list(ene, dt) %>%
reduce(full_join, by = c("ID", "ano")) %>%
arrange(ano, ID) %>%
filter(ano %in% 2010:2023) %>%
mutate(across(total:por_cen,
~tidyr::replace_na(., 0)),
tasa_afiliacion = ifelse(if_all(c(n_afil_tot, total), ~.!=0), round((n_afil_tot/total)*100,3), 0),
por_cobertura = ifelse(if_all(c(cubiertos_tot, total), ~.!=0), round((cubiertos_tot/total)*100,3), 0),
por_cobertura_cont = ifelse(if_all(c(cubiertos_cont, total), ~.!=0), round((cubiertos_cont/total)*100,3), 0),
por_cobertura_otro = ifelse(if_all(c(cubiertos_otro, total), ~.!=0), round((cubiertos_otro/total)*100,3), 0),
n_sind_mil = ifelse(if_all(c(n_sind, total), ~.!=0), round((n_sind/(total/1000))*100,3), 0)) %>%
arrange(ID, ano) %>%
#group_by(ID, ano) %>%
mutate(across(c(tasa_afiliacion, por_cobertura, por_cobertura_cont, por_cobertura_otro),
~ifelse(year %in% 2011:2023, dplyr::lag(.), 0),
.names = "lag_{.col}")) %>%
ungroup()
# Unificar ----------------------------------------------------------------
data = list(ene, dt) %>%
reduce(full_join, by = c("ID", "ano")) %>%
arrange(ano, ID) %>%
filter(ano %in% 2010:2023) %>%
mutate(across(total:por_cen,
~tidyr::replace_na(., 0)),
tasa_afiliacion = ifelse(if_all(c(n_afil_tot, total), ~.!=0), round((n_afil_tot/total)*100,3), 0),
por_cobertura = ifelse(if_all(c(cubiertos_tot, total), ~.!=0), round((cubiertos_tot/total)*100,3), 0),
por_cobertura_cont = ifelse(if_all(c(cubiertos_cont, total), ~.!=0), round((cubiertos_cont/total)*100,3), 0),
por_cobertura_otro = ifelse(if_all(c(cubiertos_otro, total), ~.!=0), round((cubiertos_otro/total)*100,3), 0),
n_sind_mil = ifelse(if_all(c(n_sind, total), ~.!=0), round((n_sind/(total/1000))*100,3), 0)) %>%
arrange(ID, ano) %>%
#group_by(ID, ano) %>%
mutate(across(c(tasa_afiliacion, por_cobertura, por_cobertura_cont, por_cobertura_otro),
~ifelse(ano %in% 2011:2023, dplyr::lag(.), 0),
.names = "lag_{.col}")) %>%
ungroup()
View(data)
# Exportar ----------------------------------------------------------------
saveRDS("output/data/data_dt_ene_final.rds")
# Exportar ----------------------------------------------------------------
saveRDS(data,"output/data/data_dt_ene_final.rds")
