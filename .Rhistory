min = ~min(.),
max = ~max(.)))) %>%
pivot_longer(everything()) %>%
mutate(stat = str_extract(name, pattern = "(?<=_).*"),
name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_"))
a %>%
group_by(rut_empresa) %>%
summarise(sii = n_distinct(id_cae2),
dt = n_distinct(cae_dt),
armonizacion = n_distinct(ID)) %>%
summarise(across(c(sii, dt, armonizacion),
list(mean = ~mean(.),
q1 = ~quantile(., 0.25),
q2 = ~quantile(., 0.5),
q3 = ~quantile(., 0.75),
min = ~min(.),
max = ~max(.)))) %>%
pivot_longer(everything()) %>%
mutate(stat = str_extract(name, pattern = "(?<=_).*"),
name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
pivot_wider(id_cols = "name", values_from "value", names_from = "stat")
a %>%
group_by(rut_empresa) %>%
summarise(sii = n_distinct(id_cae2),
dt = n_distinct(cae_dt),
armonizacion = n_distinct(ID)) %>%
summarise(across(c(sii, dt, armonizacion),
list(mean = ~mean(.),
q1 = ~quantile(., 0.25),
q2 = ~quantile(., 0.5),
q3 = ~quantile(., 0.75),
min = ~min(.),
max = ~max(.)))) %>%
pivot_longer(everything()) %>%
mutate(stat = str_extract(name, pattern = "(?<=_).*"),
name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
hoja2 = read_xlsx("input/data/dt/1590_NC_y_Huelgas_2005_2023.xlsx",
sheet = "Cuadro 2", range = "B4:P15196",
na = "NULL") %>%
janitor::clean_names() %>%
select(rut_empresa, rsu,
cae_dt = cae_codigo,
ano_escrutinio_h = ano_escrutinio, fecha_escrutinio_h = fecha_escrutinio,
trab_mas_h = trabajadores_hombres,
trab_fem_h = trabajadores_mujeres,
trab_tot_h = trabajadores,
region_h = region,
tipo_org_h = tipo_org_sindical_y_grupo) %>%
merge(., llave, by = "rut_empresa", all.x = T)
a = merge(hoja2, read_xlsx("input/data/dt/CAE_DT_armonizado.xlsx") %>%
select(id_cae2, ID),
by = "id_cae2", all.x = T)
a %>%
group_by(rut_empresa) %>%
summarise(sii = n_distinct(id_cae2),
dt = n_distinct(cae_dt),
armonizacion = n_distinct(ID)) %>%
summarise(across(c(sii, dt, armonizacion),
list(mean = ~mean(.),
q1 = ~quantile(., 0.25),
q2 = ~quantile(., 0.5),
q3 = ~quantile(., 0.75),
min = ~min(.),
max = ~max(.)))) %>%
pivot_longer(everything()) %>%
mutate(stat = str_extract(name, pattern = "(?<=_).*"),
name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
hoja3 = read_xlsx("input/data/dt/1590_NC_y_Huelgas_2005_2023.xlsx",
sheet = "Cuadro 3", range = "B4:T2964",
na = "NULL") %>%
janitor::clean_names() %>%
select(rut_empresa = empresa, rsu = rsu_raf,
cae_dt = cod_cae,
ano_inicio_h = ano_inicio,
fecha_inicio_h = fecha_inicio,
ano_termino_h = ano_termino,
fecha_termino_h = fecha_termino,
dias_h = dias_huelga,
termino_neg_h = termino_negociacion,
trab_mas_h = trabajadores_hombres,
trab_fem_h = trabajadores_mujeres,
trab_tot_h = trabajadores,
region_h = region) %>%
mutate(rut_empresa = as.character(rut_empresa)) %>%
merge(., llave, by = "rut_empresa", all.x = T)
a = merge(hoja3, read_xlsx("input/data/dt/CAE_DT_armonizado.xlsx") %>%
select(id_cae2, ID),
by = "id_cae2", all.x = T)
a %>%
group_by(rut_empresa) %>%
summarise(sii = n_distinct(id_cae2),
dt = n_distinct(cae_dt),
armonizacion = n_distinct(ID)) %>%
summarise(across(c(sii, dt, armonizacion),
list(mean = ~mean(.),
q1 = ~quantile(., 0.25),
q2 = ~quantile(., 0.5),
q3 = ~quantile(., 0.75),
min = ~min(.),
max = ~max(.)))) %>%
pivot_longer(everything()) %>%
mutate(stat = str_extract(name, pattern = "(?<=_).*"),
name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
rm(list = ls())
# Procesamiento data OOSS --------------------------------------
# Cargar paquetes ---------------------------------------------------------
pacman::p_load(tidyverse, readxl, sjmisc)
# Cargar datos ------------------------------------------------------------
llave = readRDS("input/data/dt/CAE_RUT_FINAL.rds") %>%
select(rut_empresa = rut, dv, id_cae2) %>%
mutate(across(c(rut_empresa, dv), ~as.character(.)),
id_cae2 = as.numeric(id_cae2))
files = list.files(path = "input/data/dt",
pattern = "1594")
#Microdatos
ooss_micro = map(files,
~ read_xlsx(paste0("input/data/dt/", .x),
na = c("SIN INFORMACIÓN", "NULL")) %>%
janitor::clean_names())
names(ooss_micro) = str_extract(files, pattern = "(OOSS_|COES_)\\d{4}")
ooss_micro = imap(ooss_micro,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
ooss_micro23 = ooss_micro[[8]] %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes,
rsu_fed = rsu_federacion_rsu_fed,
rsu_cen = rsu_central_sindical_rsu_cent,
rsu_conf = rsu_confederacion_rsu_confed)
ooss_micro = bind_rows(ooss_micro[-8]) %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes)
ooss_micro = bind_rows(ooss_micro, ooss_micro23)
micro = merge(ooss_micro,
llave, by = "rut_empresa", all.x = T)
a = merge(micro, read_xlsx("input/data/dt/CAE_DT_armonizado.xlsx") %>%
select(id_cae2, ID),
by = "id_cae2", all.x = T)
a %>%
mutate(info = case_when(is.na(id_cae2) & !is.na(cae_dt) ~ "Sólo DT",
!is.na(id_cae2) & is.na(cae_dt) ~ "Sólo SII",
!is.na(id_cae2) & !is.na(cae_dt) ~ "Ambas",
TRUE ~ "Ninguna")) %>%
group_by(info) %>%
count %>%
mutate(prop = round(n/nrow(a)*100, 3))
a %>%
mutate(info = case_when(is.na(id_cae2) & !is.na(cae_1d) ~ "Sólo DT",
!is.na(id_cae2) & is.na(cae_1d) ~ "Sólo SII",
!is.na(id_cae2) & !is.na(cae_1d) ~ "Ambas",
TRUE ~ "Ninguna")) %>%
group_by(info) %>%
count %>%
mutate(prop = round(n/nrow(a)*100, 3))
table(a$cae_1d)
a %>%
group_by(rut_empresa) %>%
summarise(sii = n_distinct(cae_1d),
dt = n_distinct(cae_dt),
armonizacion = n_distinct(ID)) %>%
summarise(across(c(sii, dt, armonizacion),
list(mean = ~mean(.),
q1 = ~quantile(., 0.25),
q2 = ~quantile(., 0.5),
q3 = ~quantile(., 0.75),
min = ~min(.),
max = ~max(.)))) %>%
pivot_longer(everything()) %>%
mutate(stat = str_extract(name, pattern = "(?<=_).*"),
name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
a %>%
group_by(rut_empresa) %>%
summarise(sii = n_distinct(id_cae2),
dt = n_distinct(cae_1d),
armonizacion = n_distinct(ID)) %>%
summarise(across(c(sii, dt, armonizacion),
list(mean = ~mean(.),
q1 = ~quantile(., 0.25),
q2 = ~quantile(., 0.5),
q3 = ~quantile(., 0.75),
min = ~min(.),
max = ~max(.)))) %>%
pivot_longer(everything()) %>%
mutate(stat = str_extract(name, pattern = "(?<=_).*"),
name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
names(a)
llave = readRDS("input/data/dt/CAE_RUT_FINAL.rds") %>%
select(rut_empresa = rut, dv, id_cae2) %>%
mutate(across(c(rut_empresa, dv), ~as.character(.)),
id_cae2 = as.numeric(id_cae2)) %>%
select(-dv)
micro = merge(ooss_micro,
llave, by = "rut_empresa", all.x = T)
a = merge(micro, read_xlsx("input/data/dt/CAE_DT_armonizado.xlsx") %>%
select(id_cae2, ID),
by = "id_cae2", all.x = T)
a %>%
mutate(info = case_when(is.na(id_cae2) & !is.na(cae_1d) ~ "Sólo DT",
!is.na(id_cae2) & is.na(cae_1d) ~ "Sólo SII",
!is.na(id_cae2) & !is.na(cae_1d) ~ "Ambas",
TRUE ~ "Ninguna")) %>%
group_by(info) %>%
count %>%
mutate(prop = round(n/nrow(a)*100, 3))
a %>%
group_by(rut_empresa) %>%
summarise(sii = n_distinct(id_cae2),
dt = n_distinct(cae_1d),
armonizacion = n_distinct(ID)) %>%
summarise(across(c(sii, dt, armonizacion),
list(mean = ~mean(.),
q1 = ~quantile(., 0.25),
q2 = ~quantile(., 0.5),
q3 = ~quantile(., 0.75),
min = ~min(.),
max = ~max(.)))) %>%
pivot_longer(everything()) %>%
mutate(stat = str_extract(name, pattern = "(?<=_).*"),
name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
a %>% group_by(rut_empresa) %>% summarise(n=n()) %>% summarise(dup = sum(n>1),
uniq = sum(n==1))
sum(is.na(a$rut_empresa))
ooss_micro = map(files,
~ read_xlsx(paste0("input/data/dt/", .x),
na = c("SIN INFORMACIÓN", "NULL")) %>%
janitor::clean_names())
names(ooss_micro) = str_extract(files, pattern = "(OOSS_|COES_)\\d{4}")
ooss_micro = imap(ooss_micro,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
View(ooss_micro)
frq(ooss_micro[[1]]$rama_de_actividad_economica_de_la_ooss_de_base)
frq(ooss_micro[[1]]$codigo_rae_sirela)
frq(ooss_micro[[6]]$codigo_rae_sirela)
ooss_micro = map(files,
~ read_xlsx(paste0("input/data/dt/", .x),
na = c("SIN INFORMACIÓN", "NULL")) %>%
janitor::clean_names())
names(ooss_micro) = str_extract(files, pattern = "(OOSS_|COES_)\\d{4}")
ooss_micro = imap(ooss_micro,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
ooss_micro23 = ooss_micro[[8]] %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes,
rsu_fed = rsu_federacion_rsu_fed,
rsu_cen = rsu_central_sindical_rsu_cent,
rsu_conf = rsu_confederacion_rsu_confed)
ooss_micro = bind_rows(ooss_micro[-8]) %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes)
ooss_micro = bind_rows(ooss_micro, ooss_micro23)
#Pasa de 168.908 a 470.622
micro = merge(ooss_micro,
llave, by = "rut_empresa", all.x = T)
a = merge(micro, read_xlsx("input/data/dt/CAE_DT_armonizado.xlsx") %>%
select(id_cae2, ID),
by = "id_cae2", all.x = T)
a %>%
mutate(info = case_when(is.na(id_cae2) & !is.na(cae_1d) ~ "Sólo DT",
!is.na(id_cae2) & is.na(cae_1d) ~ "Sólo SII",
!is.na(id_cae2) & !is.na(cae_1d) ~ "Ambas",
TRUE ~ "Ninguna")) %>%
group_by(info) %>%
count %>%
mutate(prop = round(n/nrow(a)*100, 3))
a %>%
group_by(rut_empresa) %>%
summarise(sii = n_distinct(id_cae2),
dt = n_distinct(cae_1d),
armonizacion = n_distinct(ID)) %>%
summarise(across(c(sii, dt, armonizacion),
list(mean = ~mean(.),
q1 = ~quantile(., 0.25),
q2 = ~quantile(., 0.5),
q3 = ~quantile(., 0.75),
min = ~min(.),
max = ~max(.)))) %>%
pivot_longer(everything()) %>%
mutate(stat = str_extract(name, pattern = "(?<=_).*"),
name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
source("~/GitHub/proyecto_sindicalizacion/R/proc_dt_ooss.R")
ooss_micro = map(files,
~ read_xlsx(paste0("input/data/dt/", .x),
na = c("SIN INFORMACIÓN", "NULL")) %>%
janitor::clean_names())
rm(list = ls())
# Procesamiento data OOSS --------------------------------------
# Cargar paquetes ---------------------------------------------------------
pacman::p_load(tidyverse, readxl, sjmisc)
# Cargar datos ------------------------------------------------------------
llave = readRDS("input/data/dt/CAE_RUT_FINAL.rds") %>%
select(rut_empresa = rut, dv, id_cae2) %>%
mutate(across(c(rut_empresa, dv), ~as.character(.)),
id_cae2 = as.numeric(id_cae2)) %>%
select(-dv)
files = list.files(path = "input/data/dt",
pattern = "1594")
#Microdatos
ooss_micro = map(files,
~ read_xlsx(paste0("input/data/dt/", .x),
na = c("SIN INFORMACIÓN", "NULL")) %>%
janitor::clean_names())
names(ooss_micro) = str_extract(files, pattern = "(OOSS_|COES_)\\d{4}")
ooss_micro = imap(ooss_micro,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
ooss_micro23 = ooss_micro[[8]] %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes,
rsu_fed = rsu_federacion_rsu_fed,
rsu_cen = rsu_central_sindical_rsu_cent,
rsu_conf = rsu_confederacion_rsu_confed)
ooss_micro = bind_rows(ooss_micro[-8]) %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes)
ooss_micro = bind_rows(ooss_micro, ooss_micro23)
#Pasa de 168.908 a 470.622
micro = merge(ooss_micro,
llave, by = "rut_empresa", all.x = T)
a = merge(micro, read_xlsx("input/data/dt/CAE_DT_armonizado.xlsx") %>%
select(id_cae2, ID),
by = "id_cae2", all.x = T)
a %>%
mutate(info = case_when(is.na(id_cae2) & !is.na(cae_1d) ~ "Sólo DT",
!is.na(id_cae2) & is.na(cae_1d) ~ "Sólo SII",
!is.na(id_cae2) & !is.na(cae_1d) ~ "Ambas",
TRUE ~ "Ninguna")) %>%
group_by(info) %>%
count %>%
mutate(prop = round(n/nrow(a)*100, 3))
a %>%
group_by(rut_empresa) %>%
summarise(sii = n_distinct(id_cae2),
dt = n_distinct(cae_1d),
armonizacion = n_distinct(ID)) %>%
summarise(across(c(sii, dt, armonizacion),
list(mean = ~mean(.),
q1 = ~quantile(., 0.25),
q2 = ~quantile(., 0.5),
q3 = ~quantile(., 0.75),
min = ~min(.),
max = ~max(.)))) %>%
pivot_longer(everything()) %>%
mutate(stat = str_extract(name, pattern = "(?<=_).*"),
name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
a %>% group_by(rut_empresa) %>% summarise(n=n()) %>% summarise(dup = sum(n>1),
uniq = sum(n==1))
a = merge(llave, read_xlsx("input/data/dt/CAE_DT_armonizado.xlsx") %>%
select(id_cae2, ID),
by = "id_cae2", all.x = T)
View(a)
a %>%
group_by(rut_empresa, id_cae2) %>%
mutate(n = n()) %>%
ungroup() %>%
summarise(uniq = sum(n==1),
dup = sum(n>1))
a %>%
group_by(rut_empresa, id_cae2) %>%
mutate(n = n()) %>%
ungroup() %>%
summarise(uniq = sum(n==1),
uniq_p = sum(n==1)/nrow(.)*100,
dup = sum(n>1))
a %>%
group_by(rut_empresa, id_cae2) %>%
mutate(n = n()) %>%
ungroup() %>%
summarise(uniq = sum(n==1),
uniq_p = sum(n==1)/nrow(.)*100,
dup = sum(n>1),
dup_p = sum(n==1)/nrow(.)*100)
a %>%
group_by(rut_empresa, ID) %>%
mutate(n = n()) %>%
ungroup() %>%
summarise(uniq = sum(n==1),
uniq_p = sum(n==1)/nrow(.)*100,
dup = sum(n>1),
dup_p = sum(n>1)/nrow(.)*100)
a %>%
group_by(rut_empresa, id_cae2) %>%
mutate(n = n()) %>%
ungroup() %>%
summarise(uniq = sum(n==1),
uniq_p = sum(n==1)/nrow(.)*100,
dup = sum(n>1),
dup_p = sum(n==1)/nrow(.)*100)
a %>%
group_by(rut_empresa, id_cae2) %>%
mutate(n = 1:n()) %>%
ungroup() %>%
summarise(uniq = sum(n==1),
uniq_p = sum(n==1)/nrow(.)*100,
dup = sum(n>1),
dup_p = sum(n==1)/nrow(.)*100)
a %>%
group_by(rut_empresa, ID) %>%
mutate(n = 1:n()) %>%
ungroup() %>%
summarise(uniq = sum(n==1),
uniq_p = sum(n==1)/nrow(.)*100,
dup = sum(n>1),
dup_p = sum(n>1)/nrow(.)*100)
a %>%
group_by(rut_empresa, id_cae2) %>%
mutate(n = 1:n()) %>%
ungroup() %>%
summarise(uniq = sum(n==1),
uniq_p = sum(n==1)/nrow(.)*100,
dup = sum(n>1),
dup_p = sum(n>1)/nrow(.)*100)
a %>%
group_by(rut_empresa, id_cae2) %>%
mutate(n = n()) %>%
ungroup() %>%
summarise(uniq = sum(n==1),
uniq_p = sum(n==1)/nrow(.)*100,
dup = sum(n>1),
dup_p = sum(n>1)/nrow(.)*100)
a %>%
group_by(rut_empresa, ID) %>%
mutate(n = n()) %>%
ungroup() %>%
summarise(uniq = sum(n==1),
uniq_p = sum(n==1)/nrow(.)*100,
dup = sum(n>1),
dup_p = sum(n>1)/nrow(.)*100)
a %>%
group_by(rut_empresa) %>%
summarise(serv = sum(ID %in% 39:43))
a %>%
#group_by(rut_empresa) %>%
summarise(serv = sum(ID %in% 39:43, na.rm=T))
a %>%
#group_by(rut_empresa) %>%
summarise(serv = sum(ID %in% 39:43, na.rm=T)/nrow(.))
