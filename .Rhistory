#   mutate(info = case_when(is.na(codigoactividad) & !is.na(codigoactividad) ~ "Sólo DT",
#                           !is.na(codigoactividad) & is.na(codigoactividad) ~ "Sólo SII",
#                           !is.na(codigoactividad) & !is.na(codigoactividad) ~ "Ambas",
#                           TRUE ~ "Ninguna")) %>%
#   group_by(info) %>%
#   count %>%
#   mutate(prop = round(n/nrow(hoja2)*100, 3))
#
# hoja2 %>%
#   group_by(rut_empresa) %>%
#   summarise(sii = n_distinct(codigoactividad),
#             dt = n_distinct(codigoactividad),
#             armonizacion = n_distinct(ID2)) %>%
#   summarise(across(c(sii, dt, armonizacion),
#                    list(mean = ~mean(.),
#                         q1 = ~quantile(., 0.25),
#                         q2 = ~quantile(., 0.5),
#                         q3 = ~quantile(., 0.75),
#                         min = ~min(.),
#                         max = ~max(.)))) %>%
#   pivot_longer(everything()) %>%
#   mutate(stat = str_extract(name, pattern = "(?<=_).*"),
#          name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
#   pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
#
# hoja2 %>% group_by(rut_empresa) %>% summarise(n=n()) %>% summarise(dup = sum(n>1),
#                                                                uniq = sum(n==1))
#
# sum(is.na(hoja2$rut_empresa))
saveRDS(hoja2, "input/data/dt/huelgas_ntrab_dt.rds")
#Cuadro 3: Listado de huelgas terminadas. Desde 01 enero 2005 al 30 septiembre 2023
#n=2960
hoja3 = read_xlsx("input/data/dt/1590_NC_y_Huelgas_2005_2023.xlsx",
sheet = "Cuadro 3", range = "B4:T2964",
na = "NULL") %>%
janitor::clean_names() %>%
select(rut_empresa = empresa, rsu = rsu_raf,
codigoactividad = cod_cae,
ano = ano_inicio,
fecha = fecha_inicio,
dias_h = dias_huelga,
resultado_neg_h = termino_negociacion,
trab_mas_h = trabajadores_hombres,
trab_fem_h = trabajadores_mujeres,
trab_tot_h = trabajadores) %>%
mutate(codigoactividad = as.numeric(ifelse(nchar(codigoactividad) == 5,
str_extract(codigoactividad, "\\d{1}"),
str_extract(codigoactividad, "\\d{2}"))),
rut_empresa = as.character(rut_empresa)) %>% #antes merge 71.954
merge(., llave, by = "rut_empresa", all.x = T) %>% #despues merge 72.158
merge(.,
read_xlsx("input/data/dt/CAE_DT_armonizado.xlsx") %>%
select(codigoactividad, ID2dt=ID2) %>% unique,
by = "codigoactividad", all.x = T) %>%
mutate(
# codigoactividad = case_when(codigoactividad %in% 5:9 ~ 5,
#                    codigoactividad %in% 10:12 ~ 6,
#                    codigoactividad %in% 13:14 ~ 7,
#                    codigoactividad %in% 15:17 ~ 8,
#                    codigoactividad %in% c(18, 21, 23) ~ 9,
#                    codigoactividad %in% c(19, 20, 22) ~ 10,
#                    codigoactividad %in% c(24:27, 33) ~ 11,
#                    codigoactividad %in% c(28:30) ~ 12,
#                    codigoactividad %in% c(31, 32) ~ 13,
#                    codigoactividad %in% c(35:36) ~ 14,
#                    codigoactividad %in% c(37:39) ~ 15,
#                    codigoactividad %in% c(40,41) ~ 16,
#                    codigoactividad %in% c(42) ~ 17,
#                    codigoactividad %in% c(43) ~ 18,
#                    codigoactividad %in% c(44:45) ~ 19,
#                    codigoactividad %in% c(46:47) ~ 20,
#                    codigoactividad %in% c(48) ~ 21,
#                    codigoactividad %in% c(49) ~ 22,
#                    codigoactividad %in% c(50:51) ~ 23,
#                    codigoactividad %in% c(52:53) ~ 24,
#                    codigoactividad %in% c(55:56) ~ codigoactividad - 30,
#                    codigoactividad %in% c(57:60) ~ 27,
#                    codigoactividad %in% c(61) ~ 28,
#                    codigoactividad %in% c(62:63) ~ 29,
#                    codigoactividad %in% c(64:66) ~ 30,
#                    codigoactividad %in% c(68) ~ 31,
#                    codigoactividad %in% c(69:75) ~ 32,
#                    codigoactividad %in% c(76:82) ~ 33,
#                    codigoactividad %in% c(84:88) ~ codigoactividad - 50,
#                    codigoactividad %in% c(89:93) ~ 39,
#                    codigoactividad %in% c(94:95) ~ codigoactividad - 54,
#                    codigoactividad %in% c(96:98) ~ 42,
#                    codigoactividad %in% c(99) ~ 43,
#                    TRUE ~ NA_integer_),
ID2 = factor(case_when(!is.na(ID2dt) ~ ID2dt,
!is.na(ID2sii) ~ ID2sii,
TRUE ~ NA_integer_)))
# hoja3 %>%
#   mutate(info = case_when(is.na(codigoactividad) & !is.na(codigoactividad) ~ "Sólo DT",
#                           !is.na(codigoactividad) & is.na(codigoactividad) ~ "Sólo SII",
#                           !is.na(codigoactividad) & !is.na(codigoactividad) ~ "Ambas",
#                           TRUE ~ "Ninguna")) %>%
#   group_by(info) %>%
#   count %>%
#   mutate(prop = round(n/nrow(hoja3)*100, 3))
#
# hoja3 %>%
#   group_by(rut_empresa) %>%
#   summarise(sii = n_distinct(codigoactividad),
#             dt = n_distinct(codigoactividad),
#             armonizacion = n_distinct(ID2)) %>%
#   summarise(across(c(sii, dt, armonizacion),
#                    list(mean = ~mean(.),
#                         q1 = ~quantile(., 0.25),
#                         q2 = ~quantile(., 0.5),
#                         q3 = ~quantile(., 0.75),
#                         min = ~min(.),
#                         max = ~max(.)))) %>%
#   pivot_longer(everything()) %>%
#   mutate(stat = str_extract(name, pattern = "(?<=_).*"),
#          name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
#   pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
#
# hoja3 %>% group_by(rut_empresa) %>% summarise(n=n()) %>% summarise(dup = sum(n>1),
#                                                                uniq = sum(n==1))
sum(is.na(hoja3$rut_empresa))
saveRDS(hoja3, "input/data/dt/huelgas_dur_dt.rds")
rm(list = ls())
# Procesamiento data OOSS --------------------------------------
# Cargar paquetes ---------------------------------------------------------
pacman::p_load(tidyverse, readxl, sjmisc)
# Cargar datos ------------------------------------------------------------
llave = readRDS("input/data/dt/CAE_RUT_FINAL.rds") %>%
select(rut_empresa = rut, dv, codigoactividad) %>%
mutate(across(c(rut_empresa, dv), ~as.character(.)),
codigoactividad = ifelse(nchar(codigoactividad) == 5,
str_extract(codigoactividad, "\\d{1}"),
str_extract(codigoactividad, "\\d{2}")),
rut_empresa = paste(rut_empresa, dv, sep = "-")) %>% #con duplicados: 3.482.146
group_by(rut_empresa) %>%
mutate(n = 1:n()) %>%
#ungroup() %>%
slice(which.min(n)) %>% #Sin duplicados: 1.617.697
ungroup() %>%
select(-dv, -n)
llave = merge(llave, read_xlsx("input/data/dt/CAE_DT_armonizado.xlsx") %>%
select(codigoactividad, ID2),
by = "codigoactividad", all.x = T)
# a %>%
#   group_by(rut_empresa, codigoactividad) %>%
#   mutate(n = n()) %>%
#   ungroup() %>%
#   summarise(uniq = sum(n==1),
#             uniq_p = sum(n==1)/nrow(.)*100,
#             dup = sum(n>1),
#             dup_p = sum(n>1)/nrow(.)*100)
#
# a %>%
#   group_by(rut_empresa, ID2) %>%
#   mutate(n = n()) %>%
#   ungroup() %>%
#   summarise(uniq = sum(n==1),
#             uniq_p = sum(n==1)/nrow(.)*100,
#             dup = sum(n>1),
#             dup_p = sum(n>1)/nrow(.)*100)
#
# a %>%
#   #group_by(rut_empresa) %>%
#   summarise(serv = sum(ID2 %in% 39:43, na.rm=T)/nrow(.))
files = list.files(path = "input/data/dt",
pattern = "1594")
#Microdatos
ooss_micro = map(files,
~ read_xlsx(paste0("input/data/dt/", .x),
na = c("SIN INFORMACIÓN", "NULL"),
guess_max = 23000) %>%
janitor::clean_names())
files = list.files(path = "input/data/dt",
pattern = "1594")
#Microdatos
ooss_micro = map(files,
~ read_xlsx(paste0("input/data/dt/", .x),
na = c("SIN INFORMACIÓN", "NULL"),
guess_max = 23000) %>%
janitor::clean_names())
names(ooss_micro) = str_extract(files, pattern = "(OOSS_|COES_)\\d{4}")
ooss_micro = imap(ooss_micro,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
ooss_micro$OOSS_2019 = ooss_micro$OOSS_2019 %>% #bind_rows() %>%
mutate(tipo_de_organizacion_sindical_de_base2 = ifelse(tipo_de_organizacion_sindical_de_base == "ASOCIACION DE FUNCIONARIOS",
"ASOCIACION DE FUNCIONARIOS", socios_hombres),
socios_hombres2 = as.numeric(ifelse(tipo_de_organizacion_sindical_de_base == "ASOCIACION DE FUNCIONARIOS",
socios_hombres, tipo_de_organizacion_sindical_de_base))) %>%
select(ano:region_de_la_ooss_de_base,
tipo_de_organizacion_sindical_de_base = tipo_de_organizacion_sindical_de_base2,
socios_hombres = socios_hombres2,
socias_mujeres:anno)
ooss_micro$OOSS_2020 = ooss_micro$OOSS_2020 %>% #bind_rows() %>%
mutate(codigo_rae_sirela = as.numeric(codigo_rae_sirela))
# a=ooss_micro["OOSS_2019"] %>% bind_rows() %>%
#   mutate(tipo_de_organizacion_sindical_de_base2 = ifelse(tipo_de_organizacion_sindical_de_base == "ASOCIACION DE FUNCIONARIOS", "ASOCIACION DE FUNCIONARIOS", socios_hombres),
#          socios_hombres2 = ifelse(tipo_de_organizacion_sindical_de_base == "ASOCIACION DE FUNCIONARIOS", socios_hombres, tipo_de_organizacion_sindical_de_base)) %>%
#   select(ano:region_de_la_ooss_de_base,
#          tipo_de_organizacion_sindical_de_base = tipo_de_organizacion_sindical_de_base2,
#          socios_hombres = socios_hombres2,
#          socias_mujeres:anno)
ooss_micro23 = ooss_micro[[8]] %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes,
rsu_fed = rsu_federacion_rsu_fed,
rsu_cen = rsu_central_sindical_rsu_cent,
rsu_conf = rsu_confederacion_rsu_confed
) %>%
mutate(rut_empresa = paste(rut_empresa, dv, sep = "-")) %>%
dplyr::select(-dv) %>%
merge(., llave, by = "rut_empresa", all.x = T)
ooss_micro = bind_rows(ooss_micro[-8]) %>%
select(rut_empresa, dv, ano,
rsu = rsu_organizacion_sindical_de_base,
cae_1d = codigo_rae_sirela,
trab_tot_emp = cantidad_de_trabajadores_en_la_empresa_afc,
tamano_emp = tamano_empresa_afc,
region = region_de_la_ooss_de_base,
tipo_org = tipo_de_organizacion_sindical_de_base,
afil_mas = socios_hombres,
afil_fem = socias_mujeres,
afil_tot = total_socios,
n_dir_mas = n_de_dirigentes_hombres,
n_dir_fem = n_de_dirigentas_mujeres,
n_dir_tot = n_total_dirigentes)
ooss_micro = ooss_micro %>% #sin merge 168.908
mutate(rut_empresa = paste(rut_empresa, dv, sep = "-")) %>%
select(-dv) %>%
merge(., llave, by = "rut_empresa", all.x = T)  #Con merge 169.230
#Pasa de 168.908 a 470.622
a = ooss_micro %>% filter(ano == 2019 & !is.na(ID2))
# ooss_micro_b %>%
#   mutate(info = case_when(is.na(codigoactividad) & !is.na(cae_1d) ~ "Sólo DT",
#                           !is.na(codigoactividad) & is.na(cae_1d) ~ "Sólo SII",
#                           !is.na(codigoactividad) & !is.na(cae_1d) ~ "Ambas",
#                           TRUE ~ "Ninguna")) %>%
#   group_by(info) %>%
#   count %>%
#   mutate(prop = round(n/nrow(ooss_micro_b)*100, 3))
#
# ooss_micro_b %>%
#   group_by(rut_empresa) %>%
#   summarise(sii = n_distinct(codigoactividad),
#             dt = n_distinct(cae_1d),
#             armonizacion = n_distinct(ID2)) %>%
#   summarise(across(c(sii, dt, armonizacion),
#                    list(mean = ~mean(.),
#                         q1 = ~quantile(., 0.25),
#                         q2 = ~quantile(., 0.5),
#                         q3 = ~quantile(., 0.75),
#                         min = ~min(.),
#                         max = ~max(.)))) %>%
#   pivot_longer(everything()) %>%
#   mutate(stat = str_extract(name, pattern = "(?<=_).*"),
#          name = str_remove(str_extract(name, pattern = ".*(?<=_)"), "_")) %>%
#   pivot_wider(id_cols = "name", values_from = "value", names_from = "stat")
# a %>% group_by(rut_empresa) %>% summarise(n=n()) %>% summarise(dup = sum(n>1),
#                                                                uniq = sum(n==1))
#sum(is.na(a$rut_empresa))
saveRDS(ooss_micro, "input/data/dt/ooss_micro.rds")
#Federaciones
ooss_fed = map(files[-8],
~ read_xlsx(paste0("input/data/dt/", .x),
sheet = "Federaciones",
na = "SIN INFORMACIÓN") %>%
janitor::clean_names() %>%
mutate(across(c(rsu_federacion_rsu_fed, rsu_raf), ~as.character(.))))
names(ooss_fed) = str_extract(files[-8], pattern = "OOSS_\\d{4}")
ooss_fed = imap(ooss_fed,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
ooss_fed = bind_rows(ooss_fed) %>%
select(rsu = rsu_raf, ano = anno,
rsu_fed = rsu_federacion_rsu_fed,
tipo_org_fed = tipo_de_federacion)
saveRDS(ooss_fed, "input/data/dt/ooss_fed.rds")
#Confederaciones
ooss_conf = map(files[-8],
~ read_xlsx(paste0("input/data/dt/", .x),
sheet = "Confederaciones",
na = "SIN INFORMACIÓN") %>%
janitor::clean_names() %>%
mutate(across(c(rsu_confederacion_rsu_confed, rsu_raf), ~as.character(.))))
names(ooss_conf) = str_extract(files[-8], pattern = "OOSS_\\d{4}")
ooss_conf = imap(ooss_conf,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
ooss_conf = bind_rows(ooss_conf) %>%
select(rsu = rsu_raf, ano = anno,
rsu_conf = rsu_confederacion_rsu_confed,
tipo_org_conf = tipo_de_confederacion)
saveRDS(ooss_conf, "input/data/dt/ooss_conf.rds")
#Centrales
ooss_cen = map(files[-8],
~ read_xlsx(paste0("input/data/dt/", .x),
sheet = "Centrales",
na = "SIN INFORMACIÓN") %>%
janitor::clean_names() %>%
mutate(across(c(rsu_central_sindical_rsu_cent, rsu_raf), ~as.character(.))))
names(ooss_cen) = str_extract(files[-8], pattern = "OOSS_\\d{4}")
ooss_cen = imap(ooss_cen,
~ .x %>%
mutate(anno = str_extract(.y, pattern = "\\d{4}$")))
ooss_cen = bind_rows(ooss_cen) %>%
select(rsu = rsu_raf, ano = anno,
rsu_cen = rsu_central_sindical_rsu_cent,
tipo_org_cen = sigla)
saveRDS(ooss_cen, "input/data/dt/ooss_cen.rds")
# Unificar ----------------------------------------------------------------
ooss = ooss_micro %>%
merge(.,
ooss_fed, by = c("rsu", "ano"),
all.x = T) %>%
merge(.,
ooss_conf, by = c("rsu", "ano"),
all.x = T) %>%
merge(.,
ooss_cen, by = c("rsu", "ano"),
all.x = T) %>%
bind_rows(., ooss_micro23) %>%
mutate(across(starts_with("rsu_"), ~ifelse(. == "-", NA, .)),
rut_empresa = ifelse(rut_empresa %in% c("0", "0-NA"), NA, rut_empresa),
)
saveRDS(ooss, "input/data/dt/ooss.rds")
#169230
frq(ooss$cae_1d)
rm(list=ls())
# Rev datos DT - total ----------------------------------------------------
# Cargar paquetes ---------------------------------------------------------
pacman::p_load(tidyverse, sjmisc, readxl, data.table)
# Cargar data -------------------------------------------------------------
# llave = read_xlsx("input/data/dt/CAE_DT_armonizado.xlsx") %>%
#   select(ID, ID2) %>%
#   unique
# NC y Huelgas ------------------------------------------------------------
files = list.files("input/data/dt", pattern = ".rds")[2:4]
nc_h = map(files, ~readRDS(paste0("input/data/dt/", .x)) #%>% merge(., llave, by = "ID", all.x = T)
)
names(nc_h) = str_remove(files, pattern = ".rds$")
list2env(nc_h, globalenv())
rm(nc_h)
# OOSS --------------------------------------------------------------------
ooss = readRDS("input/data/dt/ooss.rds") #%>% merge(., llave,
#by = "ID", all.x = T)
# Estimaciones ------------------------------------------------------------
# Número de trabajadores --------------------------------------------------
h_nt = huelgas_ntrab_dt %>%
group_by(rut_empresa, rsu, codigoactividad, ano, fecha, trab_mas_h, trab_fem_h,
trab_tot_h, tipo_org_h, codigoactividad_sii, ID2) %>%
mutate(n = 1:n()) %>%
filter(n==1) %>%
ungroup() %>%
group_by(ID2, ano) %>%
summarise(n_huelgas = n(),
n_trab_huelga_tot = sum(trab_tot_h, na.rm = T),
n_trab_huelga_fem = sum(trab_fem_h, na.rm = T),
n_trab_huelga_mas = sum(trab_mas_h, na.rm = T),
mean_trab_huelga_tot = mean(trab_tot_h, na.rm = T),
mean_trab_huelga_fem = mean(trab_fem_h, na.rm = T),
mean_trab_huelga_mas = mean(trab_mas_h, na.rm = T)) %>%
filter(!is.na(ID2))
h_dur = huelgas_dur_dt %>%
group_by(rut_empresa, rsu, codigoactividad, ano, fecha, dias_h, resultado_neg_h, trab_mas_h,
trab_fem_h, trab_tot_h, codigoactividad_sii, ID2) %>%
mutate(n = 1:n()) %>%
filter(n==1) %>%
ungroup() %>%
group_by(ID2, ano) %>%
summarise(huelgas_dur = mean(dias_h, na.rm = T),
n_dptp = sum(trab_tot_h*dias_h),
mean_dptp = mean(trab_tot_h*dias_h)) %>%
filter(!is.na(ID2))
nc = neg_col_dt %>%
group_by(rut_empresa, rsu, codigoactividad, ano, trab_empresa_nc, tipo_inst, tipo_neg,
trab_mas_nc, trab_fem_nc, trab_tot_nc, codigoactividad_sii, ID2) %>%
mutate(n = 1:n()) %>%
filter(n==1) %>%
ungroup() %>%
group_by(ID2, ano) %>%
filter(trab_tot_nc < quantile(trab_tot_nc, .99, na.rm=T)) %>%
summarise(cubiertos_tot = sum(trab_tot_nc, na.rm = T),
cubiertos_fem = sum(trab_fem_nc, na.rm = T),
cubiertos_mas = sum(trab_mas_nc, na.rm = T)) %>%
filter(!is.na(ID2))
nc_contrato = neg_col_dt %>%
group_by(rut_empresa, rsu, codigoactividad, ano, trab_empresa_nc, tipo_inst, tipo_neg,
trab_mas_nc, trab_fem_nc, trab_tot_nc, codigoactividad_sii, ID2) %>%
mutate(n = 1:n()) %>%
filter(n==1 & tipo_inst == "Contrato Colectivo") %>%
ungroup() %>%
group_by(ID2, ano) %>%
filter(trab_tot_nc < quantile(trab_tot_nc, .99, na.rm=T)) %>%
summarise(cubiertos_cont = sum(trab_tot_nc, na.rm = T),
cubiertos_cont_fem = sum(trab_fem_nc, na.rm = T),
cubiertos_cont_mas = sum(trab_mas_nc, na.rm = T)) %>%
filter(!is.na(ID2))
nc_otro = neg_col_dt %>%
group_by(rut_empresa, rsu, codigoactividad, ano, trab_empresa_nc, tipo_inst, tipo_neg,
trab_mas_nc, trab_fem_nc, trab_tot_nc, codigoactividad_sii, ID2) %>%
mutate(n = 1:n()) %>%
filter(n==1 & tipo_inst != "Contrato Colectivo") %>%
ungroup() %>%
group_by(ID2, ano) %>%
filter(trab_tot_nc < quantile(trab_tot_nc, .975, na.rm=T)) %>%
summarise(cubiertos_otro = sum(trab_tot_nc, na.rm = T),
cubiertos_otro_fem = sum(trab_fem_nc, na.rm = T),
cubiertos_otro_mas = sum(trab_mas_nc, na.rm = T)) %>%
filter(!is.na(ID2))
sind = ooss %>%
select(-c(cae_1d)) %>%
group_by(rsu, ano, rut_empresa) %>%
mutate(n = 1:n()) %>%
filter(n==1 & !tipo_org %in% c("Asociacion de funcionarios", "ASOCIACION DE FUNCIONARIOS")) %>%
ungroup() %>%
group_by(ID2, ano) %>%
filter(afil_tot < quantile(afil_tot, .975, na.rm=T)) %>%
summarise(n_sind = n(),
n_afil_tot = sum(afil_tot, na.rm = T),
n_afil_mas = sum(afil_mas, na.rm = T),
n_afil_fem = sum(afil_fem, na.rm = T),
mean_afil_tot = mean(afil_tot, na.rm = T),
mean_afil_mas = mean(afil_mas, na.rm = T),
mean_afil_fem = mean(afil_fem, na.rm = T),
por_dir_fem = round(sum(n_dir_mas<n_dir_tot, na.rm = T)/n()*100,3),
por_fed = round(sum(!is.na(rsu_fed))/n()*100, 3),
por_conf = round(sum(!is.na(rsu_conf))/n()*100, 3),
por_cen = round(sum(!is.na(rsu_cen))/n()*100, 3)) %>%
ungroup() %>%
mutate(ID2 = factor(ID2)) %>%
filter(!is.na(ID2))
data = list(nc, nc_contrato, nc_otro, h_nt, h_dur, sind) %>%
reduce(full_join, by = c("ID2", "ano"))
saveRDS(data, "output/data/data_dt_proc_final.rds")
rm(list=ls())
# Unificar data ENE - DT (OOSS-NC-H) --------------------------------------
# Cargar paquetes ---------------------------------------------------------
pacman::p_load(tidyverse, sjmisc, writexl)
# Cargar data -------------------------------------------------------------
dt = readRDS("output/data/data_dt_proc_final.rds")
ene = readRDS("output/data/ene_final_ID.rds") %>%
mutate(ID2 = factor(ID2),
ano = as.numeric(ano)) %>%
filter(!is.na(ID2) & ID2 != "Total")
olas = data.frame(ID2 = factor(rep(c(1:34), 14)),
ano = map(2010:2023, ~rep(.x, 34)) %>% unlist())
# Unificar ----------------------------------------------------------------
data = list(ene, dt) %>%
reduce(full_join, by = c("ID2", "ano")) %>%
merge(olas,
.,
by = c("ano", "ID2"), all = T) %>%
arrange(ano, ID2) %>%
filter(ano %in% 2010:2023 & ID2 != "34") %>%
mutate(across(total:por_cen,
~tidyr::replace_na(., 0)),
tasa_afiliacion = ifelse(if_all(c(n_afil_tot, total), ~.!=0), round((n_afil_tot/total)*100,3), 0),
por_cobertura = ifelse(if_all(c(cubiertos_tot, total), ~.!=0), round((cubiertos_tot/total)*100,3), 0),
por_cobertura_cont = ifelse(if_all(c(cubiertos_cont, total), ~.!=0), round((cubiertos_cont/total)*100,3), 0),
por_cobertura_otro = ifelse(if_all(c(cubiertos_otro, total), ~.!=0), round((cubiertos_otro/total)*100,3), 0),
n_sind_mil = ifelse(if_all(c(n_sind, total), ~.!=0), round((n_sind/(total/1000))*100,3), 0)) %>%
arrange(ID2, ano) %>%
#group_by(ID2, ano) %>%
mutate(across(c(tasa_afiliacion, por_cobertura, por_cobertura_cont, por_cobertura_otro),
~ifelse(ano %in% 2011:2023, dplyr::lag(.), 0),
.names = "lag_{.col}")) %>%
ungroup()
# Exportar ----------------------------------------------------------------
saveRDS(data,"output/data/data_dt_ene_final.rds")
# Explorar bugs -----------------------------------------------------------
#% mayores a 100
data %>%
summarise(across(c(tasa_afiliacion, por_cobertura, por_cobertura_cont),
~sum(. > 100)))
data %>%
filter(if_any(c(tasa_afiliacion, por_cobertura, por_cobertura_cont),
~.>100)) %>%
select(ID2, ano,
total, n_afil_tot, tasa_afiliacion,
cubiertos_tot, por_cobertura,
cubiertos_cont, por_cobertura_cont,
n_sind) %>%
write_xlsx("rev_porcentajes.xlsx")
ids=data %>%
filter(if_any(c(tasa_afiliacion, por_cobertura, por_cobertura_cont),
~.>100)) %>%
select(ID2) %>% unique() %>% pull()
j=data %>%
#filter(ID2 %in% ids) %>%
select(ID2, ano,
total, n_afil_tot, tasa_afiliacion,
cubiertos_tot, por_cobertura,
cubiertos_cont, por_cobertura_cont,
n_sind)
j=data %>%
filter(ID2 %in% ids) %>%
select(ID2, ano,
total, n_afil_tot, tasa_afiliacion,
cubiertos_tot, por_cobertura,
cubiertos_cont, por_cobertura_cont,
n_sind)
